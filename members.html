<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Member Details Viewer</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; }
  select { padding: 8px; font-size: 16px; width: 100%; max-width: 400px; }
  #details { margin-top: 20px; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #f0f0f0; }
  h2, h3 { margin-top: 30px; }
  #loading { font-style: italic; color: #666; margin-top: 10px; }
</style>
</head>
<body>

<h1>Member Details Viewer</h1>

<label for="memberSelect">Select Member:</label>
<select id="memberSelect" disabled>
  <option value="">-- Loading members... --</option>
</select>

<div id="loading"></div>
<div id="details"></div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
const csvUrls = {
  roleTaking:        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDdWUbjkeHCHq6fBUKFUmq8TJ_Mp0V3zhzmgm5Ds7Fed0dqdqR5c2oy2SzJuvVwwSJ6egCfB6FALPa/pub?gid=23380471&single=true&output=csv",
  speeches:          "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDdWUbjkeHCHq6fBUKFUmq8TJ_Mp0V3zhzmgm5Ds7Fed0dqdqR5c2oy2SzJuvVwwSJ6egCfB6FALPa/pub?gid=170161438&single=true&output=csv",
  evaluations:       "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDdWUbjkeHCHq6fBUKFUmq8TJ_Mp0V3zhzmgm5Ds7Fed0dqdqR5c2oy2SzJuvVwwSJ6egCfB6FALPa/pub?gid=335593996&single=true&output=csv",
  levelCompletions:  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDdWUbjkeHCHq6fBUKFUmq8TJ_Mp0V3zhzmgm5Ds7Fed0dqdqR5c2oy2SzJuvVwwSJ6egCfB6FALPa/pub?gid=1646576393&single=true&output=csv",
  awards:            "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDdWUbjkeHCHq6fBUKFUmq8TJ_Mp0V3zhzmgm5Ds7Fed0dqdqR5c2oy2SzJuvVwwSJ6egCfB6FALPa/pub?gid=302763050&single=true&output=csv",
  excomSub:          "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDdWUbjkeHCHq6fBUKFUmq8TJ_Mp0V3zhzmgm5Ds7Fed0dqdqR5c2oy2SzJuvVwwSJ6egCfB6FALPa/pub?gid=710668362&single=true&output=csv",
  tableTopics:       "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDdWUbjkeHCHq6fBUKFUmq8TJ_Mp0V3zhzmgm5Ds7Fed0dqdqR5c2oy2SzJuvVwwSJ6egCfB6FALPa/pub?gid=618267332&single=true&output=csv",
  earlyAttendance:   "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDdWUbjkeHCHq6fBUKFUmq8TJ_Mp0V3zhzmgm5Ds7Fed0dqdqR5c2oy2SzJuvVwwSJ6egCfB6FALPa/pub?gid=1928408168&single=true&output=csv",
  summary:           "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDdWUbjkeHCHq6fBUKFUmq8TJ_Mp0V3zhzmgm5Ds7Fed0dqdqR5c2oy2SzJuvVwwSJ6egCfB6FALPa/pub?gid=1556398249&single=true&output=csv",
  total:             "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDdWUbjkeHCHq6fBUKFUmq8TJ_Mp0V3zhzmgm5Ds7Fed0dqdqR5c2oy2SzJuvVwwSJ6egCfB6FALPa/pub?gid=1939085341&single=true&output=csv",
  attendance:        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDdWUbjkeHCHq6fBUKFUmq8TJ_Mp0V3zhzmgm5Ds7Fed0dqdqR5c2oy2SzJuvVwwSJ6egCfB6FALPa/pub?gid=1192815434&single=true&output=csv",
  lastMinuteRoles:   "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDdWUbjkeHCHq6fBUKFUmq8TJ_Mp0V3zhzmgm5Ds7Fed0dqdqR5c2oy2SzJuvVwwSJ6egCfB6FALPa/pub?gid=10890228&single=true&output=csv"
};

const allData = {};

function fetchAndParseCSV(url) {
  return new Promise((resolve, reject) => {
    Papa.parse(url, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: (results) => {
        resolve(results.data);
      },
      error: (err) => {
        reject(err);
      }
    });
  });
}

async function init() {
  try {
    document.getElementById("loading").textContent = "Loading data...";
    const keys = Object.keys(csvUrls);
    const promises = keys.map(key => fetchAndParseCSV(csvUrls[key]));
    const results = await Promise.all(promises);
    keys.forEach((key, i) => {
      allData[key] = results[i];
    });
    populateMemberDropdown();
    document.getElementById("loading").textContent = "";
    document.getElementById("memberSelect").disabled = false;
    setupDropdownListener();
  } catch (error) {
    document.getElementById("loading").textContent = "Failed to load data. See console.";
    console.error(error);
  }
}

function getAllMemberNames() {
  const namesSet = new Set();
  for (const datasetName in allData) {
    const data = allData[datasetName];
    if (!Array.isArray(data)) continue;
    data.forEach(row => {
      if (row["Name"] && row["Name"].trim() !== "") {
        namesSet.add(row["Name"].trim());
      }
    });
  }
  return Array.from(namesSet).sort();
}

function populateMemberDropdown() {
  const select = document.getElementById("memberSelect");
  select.innerHTML = `<option value="">-- Choose a member --</option>`;
  const members = getAllMemberNames();
  members.forEach(name => {
    const option = document.createElement("option");
    option.value = name;
    option.textContent = name;
    select.appendChild(option);
  });
}

function setupDropdownListener() {
  const select = document.getElementById("memberSelect");
  select.addEventListener("change", () => {
    const memberName = select.value;
    if (!memberName) {
      clearDetails();
      return;
    }
    displayMemberDetails(memberName);
  });
}

function clearDetails() {
  document.getElementById("details").innerHTML = "";
}

function displayMemberDetails(name) {
  const detailsDiv = document.getElementById("details");
  detailsDiv.innerHTML = `<h2>Details for ${name}</h2>`;
  let foundAny = false;

  for (const [category, data] of Object.entries(allData)) {
    const matchedRows = data.filter(row => row["Name"] && row["Name"].trim() === name);
    if (matchedRows.length > 0) {
      foundAny = true;
      detailsDiv.innerHTML += `<h3>${capitalizeWords(category)}</h3>`;
      detailsDiv.innerHTML += generateTableHTML(matchedRows);
    }
  }

  if (!foundAny) {
    detailsDiv.innerHTML += `<p>No records found for this member.</p>`;
  }
}

function generateTableHTML(dataArray) {
  if (dataArray.length === 0) return "<p>No data</p>";
  const columns = Object.keys(dataArray[0]);
  let html = "<table><thead><tr>";
  columns.forEach(col => {
    html += `<th>${col}</th>`;
  });
  html += "</tr></thead><tbody>";
  dataArray.forEach(row => {
    html += "<tr>";
    columns.forEach(col => {
      // Escape HTML special chars for safety
      const val = row[col] || "";
      html += `<td>${escapeHtml(val)}</td>`;
    });
    html += "</tr>";
  });
  html += "</tbody></table>";
  return html;
}

function escapeHtml(text) {
  if (typeof text !== 'string') return text;
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function capitalizeWords(str) {
  return str.replace(/([A-Z])/g, " $1")
            .replace(/^./, s => s.toUpperCase())
            .trim();
}

window.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>
