<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Toastmasters Points Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #fdfdfd;
      color: #2c2c2c;
      max-width: 1200px;
      margin: auto;
    }
    header {
      background-color: #00629B;
      color: #ffffff;
      padding: 20px;
      text-align: center;
    }
    header img.logo {
      height: 80px;
      margin-bottom: 10px;
    }
    h1 {
      margin: 0;
      font-size: 26px;
    }
    main {
      padding: 20px;
    }
    label {
      display: inline-block;
      margin: 10px 0 5px;
      font-weight: 600;
    }
    select, input[type="date"] {
      padding: 8px;
      margin-bottom: 15px;
      font-size: 16px;
      width: 100%;
      max-width: 300px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
    }
    .toggle-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }
    #memberDetails, #leaderboard {
      margin-top: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    th {
      background-color: #eee;
    }
    canvas {
      margin-top: 20px;
    }
    footer {
      text-align: center;
      padding: 15px;
      background-color: #00629B;
      color: #fff;
      margin-top: 40px;
    }
    .no-data {
      color: #888;
      font-style: italic;
    }
  </style>
</head>
<body>
  <header>
    <img class="logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f3/Toastmasters_International_logo.svg/2560px-Toastmasters_International_logo.svg.png" alt="Toastmasters Logo" />
    <h1>Toastmasters Points Dashboard</h1>
  </header>

  <main>
    <section class="controls">
      <div>
        <label for="memberSelect">Select Member:</label><br />
        <select id="memberSelect" disabled>
          <option value="">-- Loading Members --</option>
        </select>
      </div>

      <div>
        <label for="startDate">From:</label><br />
        <input type="date" id="startDate">
      </div>

      <div>
        <label for="endDate">To:</label><br />
        <input type="date" id="endDate">
      </div>

      <div>
        <label class="toggle-label">
          <input type="checkbox" id="toggleMeetingNumbers" />
          Show Meeting Numbers
        </label>
      </div>
    </section>

    <section id="memberDetailsSection">
      <h2>Member Points Breakdown</h2>
      <div id="memberDetails">
        <p>Please select a member and date range above.</p>
      </div>
    </section>

    <section id="leaderboardSection">
      <h2>Leaderboard</h2>
      <div id="leaderboard"></div>
      <canvas id="top5Chart" width="600" height="300"></canvas>
    </section>
  </main>

  <footer>
    <p>Â© 2025 Toastmasters Club | All Rights Reserved</p>
  </footer>
<script>
  const csvUrls = {
    roleTaking: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDdWUbjkeHCHq6fBUKFUmq8TJ_Mp0V3zhzmgm5Ds7Fed0dqdqR5c2oy2SzJuvVwwSJ6egCfB6FALPa/pub?gid=23380471&single=true&output=csv",
    speeches: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDdWUbjkeHCHq6fBUKFUmq8TJ_Mp0V3zhzmgm5Ds7Fed0dqdqR5c2oy2SzJuvVwwSJ6egCfB6FALPa/pub?gid=170161438&single=true&output=csv",
    evaluations: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDdWUbjkeHCHq6fBUKFUmq8TJ_Mp0V3zhzmgm5Ds7Fed0dqdqR5c2oy2SzJuvVwwSJ6egCfB6FALPa/pub?gid=335593996&single=true&output=csv",
    levelCompletions: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDdWUbjkeHCHq6fBUKFUmq8TJ_Mp0V3zhzmgm5Ds7Fed0dqdqR5c2oy2SzJuvVwwSJ6egCfB6FALPa/pub?gid=1646576393&single=true&output=csv",
    awards: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDdWUbjkeHCHq6fBUKFUmq8TJ_Mp0V3zhzmgm5Ds7Fed0dqdqR5c2oy2SzJuvVwwSJ6egCfB6FALPa/pub?gid=302763050&single=true&output=csv",
    excomSub: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDdWUbjkeHCHq6fBUKFUmq8TJ_Mp0V3zhzmgm5Ds7Fed0dqdqR5c2oy2SzJuvVwwSJ6egCfB6FALPa/pub?gid=710668362&single=true&output=csv",
    tableTopics: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDdWUbjkeHCHq6fBUKFUmq8TJ_Mp0V3zhzmgm5Ds7Fed0dqdqR5c2oy2SzJuvVwwSJ6egCfB6FALPa/pub?gid=618267332&single=true&output=csv",
    earlyAttendance: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDdWUbjkeHCHq6fBUKFUmq8TJ_Mp0V3zhzmgm5Ds7Fed0dqdqR5c2oy2SzJuvVwwSJ6egCfB6FALPa/pub?gid=1928408168&single=true&output=csv"
  };

  const allData = {};

  function fetchCSV(url) {
    return new Promise((resolve) => {
      Papa.parse(url, {
        download: true,
        header: true,
        complete: (results) => resolve(results.data),
      });
    });
  }

  async function loadData() {
    const keys = Object.keys(csvUrls);
    const fetches = keys.map(key => fetchCSV(csvUrls[key]));
    const results = await Promise.all(fetches);
    keys.forEach((key, i) => {
      allData[key] = results[i];
    });
    populateMemberDropdown();
  }

  function populateMemberDropdown() {
    const names = new Set();
    Object.values(allData).forEach(dataset => {
      dataset.forEach(row => {
        if (row.Name && row.Name.trim()) names.add(row.Name.trim());
      });
    });
    const sortedNames = Array.from(names).sort();
    const select = document.getElementById("memberSelect");
    select.innerHTML = `<option value="">-- Choose Member --</option>`;
    sortedNames.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      select.appendChild(opt);
    });
    select.disabled = false;
  }

  function getDateRangeFilter(startDate, endDate) {
    return (dateStr) => {
      const date = new Date(dateStr);
      return (!startDate || new Date(startDate) <= date) &&
             (!endDate || new Date(endDate) >= date);
    };
  }

  function calculatePoints(member, startDate, endDate) {
    const filterByDate = getDateRangeFilter(startDate, endDate);
    const points = {};
    let total = 0;

    function add(category, pointValue, count = 1) {
      if (!points[category]) points[category] = 0;
      points[category] += pointValue * count;
      total += pointValue * count;
    }

    allData.earlyAttendance?.forEach(row => {
      if (row.Name === member && filterByDate(row.Date)) {
        const attendance = row["Attendance Type"]?.toLowerCase();
        if (attendance === "early") add("Early Attendance", 1);
        else if (attendance === "on time") add("On-time Attendance", 0.5);
      }
    });

    allData.speeches?.forEach(row => {
      if (row.Name === member && filterByDate(row.Date)) {
        add("Speeches", 3);
      }
    });

    allData.roleTaking?.forEach(row => {
      if (row.Name === member && filterByDate(row.Date)) {
        const role = row["Role"]?.toLowerCase();
        if (role.includes("mc")) add("MC Role", row["Last Minute"] === "Yes" ? 4 : 3);
        else if (role.includes("ge")) add("General Evaluator", 2);
        else if (role.includes("ttm")) add("Table Topics Master", 2);
        else if (role.includes("timer")) add("Timer", 1);
        else if (role.includes("ah")) add("Ah Counter", 1);
        else if (role.includes("grammarian")) add("Grammarian", 1);
        else if (role.includes("listener")) add("Listener", 1);
      }
    });

    allData.evaluations?.forEach(row => {
      if (row.Name === member && filterByDate(row.Date)) {
        add("Evaluator", 2);
      }
    });

    allData.levelCompletions?.forEach(row => {
      if (row.Name === member && filterByDate(row.Date)) {
        const level = row["Level"]?.replace(/Level\s+/i, "");
        const levelPoints = { "1": 5, "2": 6, "3": 7, "4": 8, "5": 9 };
        add(`Level ${level}`, levelPoints[level] || 0);
      }
    });

    return { breakdown: points, total };
  }

  function showMemberDetails() {
    const member = document.getElementById("memberSelect").value;
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;
    if (!member) return;

    const { breakdown, total } = calculatePoints(member, startDate, endDate);
    const container = document.getElementById("memberDetails");

    if (Object.keys(breakdown).length === 0) {
      container.innerHTML = "<p>No activity data available for this member in selected range.</p>";
      return;
    }

    let html = `<table><thead><tr><th>Category</th><th>Points</th></tr></thead><tbody>`;
    Object.entries(breakdown).forEach(([category, pts]) => {
      html += `<tr><td>${category}</td><td>${pts}</td></tr>`;
    });
    html += `<tr><th>Total</th><th>${total}</th></tr>`;
    html += "</tbody></table>";
    container.innerHTML = html;
  }

  function updateLeaderboard() {
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;
    const filterByDate = getDateRangeFilter(startDate, endDate);
    const scores = {};

    const members = new Set();
    Object.values(allData).forEach(dataset => {
      dataset.forEach(row => {
        if (row.Name && filterByDate(row.Date)) {
          members.add(row.Name);
        }
      });
    });

    Array.from(members).forEach(name => {
      const { total } = calculatePoints(name, startDate, endDate);
      if (total > 0) scores[name] = total;
    });

    const leaderboard = Object.entries(scores)
      .sort((a, b) => b[1] - a[1])
      .map(([name, points], idx) => `<tr><td>${idx + 1}</td><td>${name}</td><td>${points}</td></tr>`);

    document.getElementById("leaderboard").innerHTML = `
      <table>
        <thead><tr><th>#</th><th>Name</th><th>Points</th></tr></thead>
        <tbody>${leaderboard.join("")}</tbody>
      </table>
    `;

    updateChart(Object.entries(scores).slice(0, 5));
  }

  function updateChart(top5) {
    const ctx = document.getElementById("top5Chart").getContext("2d");
    if (window.chart) window.chart.destroy();
    window.chart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: top5.map(([name]) => name),
        datasets: [{
          label: "Top 5 Members",
          data: top5.map(([, points]) => points),
          backgroundColor: "#6c307a"
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadData();
    document.getElementById("memberSelect").addEventListener("change", () => {
      showMemberDetails();
      updateLeaderboard();
    });
    document.getElementById("startDate").addEventListener("change", () => {
      showMemberDetails();
      updateLeaderboard();
    });
    document.getElementById("endDate").addEventListener("change", () => {
      showMemberDetails();
      updateLeaderboard();
    });
  });
</script>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #fafafa;
    color: #333;
    margin: 20px;
  }

  h1, h2 {
    color: #6c307a; /* Toastmasters purple */
    margin-bottom: 0.5em;
  }

  label {
    display: block;
    margin: 0.5em 0 0.2em 0;
    font-weight: 600;
  }

  select, input[type="date"] {
    padding: 0.4em 0.6em;
    border-radius: 4px;
    border: 1px solid #ccc;
    width: 220px;
    font-size: 1rem;
  }

  #memberSelect:disabled {
    background-color: #eee;
  }

  button {
    background-color: #6c307a;
    color: white;
    border: none;
    padding: 0.6em 1.2em;
    border-radius: 5px;
    font-size: 1rem;
    cursor: pointer;
    margin-top: 1em;
    transition: background-color 0.3s ease;
  }

  button:hover {
    background-color: #4b1f55;
  }

  table {
    border-collapse: collapse;
    margin-top: 1em;
    width: 100%;
    max-width: 700px;
  }

  th, td {
    border: 1px solid #ddd;
    padding: 0.6em 1em;
    text-align: left;
  }

  th {
    background-color: #6c307a;
    color: white;
  }

  tr:nth-child(even) {
    background-color: #f9f9f9;
  }

  #container {
    max-width: 900px;
    margin: auto;
  }

  #memberDetails {
    margin-top: 20px;
  }

  #leaderboard {
    margin-top: 30px;
  }

  canvas {
    margin-top: 30px;
    max-width: 700px;
  }

  @media (max-width: 600px) {
    select, input[type="date"] {
      width: 100%;
    }
  }
</style>
